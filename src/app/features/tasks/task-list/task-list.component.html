<h1>Task List</h1>
<div class="actions">
  <button
    mat-raised-button
    color="primary"
    *ngIf="isAdmin$ | async"
    (click)="openAddDialog()"
  >
    Add Task
  </button>
</div>
<div class="filters">
  <mat-form-field appearance="outline">
    <mat-label>Search Tasks</mat-label>
    <input
      matInput
      placeholder="Search by title, description, etc."
      [value]="initialSearchTerm"
      (input)="onSearch($event)"
    />
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Status</mat-label>
    <mat-select
      [value]="initialStatus"
      (selectionChange)="statusSubject.next($event.value)"
      placeholder="All"
    >
      <mat-option value="">All</mat-option>
      <mat-option value="To Do">To Do</mat-option>
      <mat-option value="In Progress">In Progress</mat-option>
      <mat-option value="In Review">In Review</mat-option>
      <mat-option value="Completed">Completed</mat-option>
    </mat-select>
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Priority</mat-label>
    <mat-select
      [value]="initialPriority"
      (selectionChange)="prioritySubject.next($event.value)"
      placeholder="All"
    >
      <mat-option value="">All</mat-option>
      <mat-option value="Low">Low</mat-option>
      <mat-option value="Medium">Medium</mat-option>
      <mat-option value="High">High</mat-option>
      <mat-option value="Critical">Critical</mat-option>
    </mat-select>
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Category</mat-label>
    <mat-select
      [value]="initialCategory"
      (selectionChange)="categorySubject.next($event.value)"
      placeholder="All"
    >
      <mat-option value="">All</mat-option>
      <mat-option *ngFor="let category of categories" [value]="category">{{
        category
      }}</mat-option>
    </mat-select>
  </mat-form-field>
</div>
<div *ngIf="loading$ | async; else taskTable">
  <p>Loading tasks...</p>
</div>
<ng-template #taskTable>
  <div *ngIf="error$ | async as error">
    <p>Error: {{ error }}</p>
  </div>
  <table
    mat-table
    [dataSource]="dataSource"
    matSort
    (matSortChange)="sortData($event)"
  >
    <ng-container matColumnDef="title">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Title</th>
      <td mat-cell *matCellDef="let task">{{ task.title }}</td>
    </ng-container>
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Description</th>
      <td mat-cell *matCellDef="let task" [innerHTML]="task.description"></td>
    </ng-container>
    <ng-container matColumnDef="priority">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
      <td mat-cell *matCellDef="let task">{{ task.priority }}</td>
    </ng-container>
    <ng-container matColumnDef="dueDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
      <td mat-cell *matCellDef="let task">{{ task.dueDate }}</td>
    </ng-container>
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
      <td mat-cell *matCellDef="let task">{{ task.status }}</td>
    </ng-container>
    <ng-container matColumnDef="category">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Category</th>
      <td mat-cell *matCellDef="let task">{{ task.category }}</td>
    </ng-container>
    <ng-container matColumnDef="tags">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Tags</th>
      <td mat-cell *matCellDef="let task">
        <mat-chip-listbox>
          <mat-chip *ngFor="let tag of task.tags">{{ tag }}</mat-chip>
        </mat-chip-listbox>
      </td>
    </ng-container>
    <ng-container matColumnDef="assignedTo">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Assigned To</th>
      <td mat-cell *matCellDef="let task">{{ task.assignedTo }}</td>
    </ng-container>
    <ng-container matColumnDef="attachments">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Attachments</th>
      <td mat-cell *matCellDef="let task">
        <span *ngIf="task.attachments.length === 0">None</span>
        <ul *ngIf="task.attachments.length > 0">
          <li *ngFor="let attachment of task.attachments">
            {{ attachment.name }} ({{ attachment.size | number }} bytes)
          </li>
        </ul>
      </td>
    </ng-container>
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let task">
        <button
          mat-icon-button
          *ngIf="isAdmin$ | async"
          (click)="openEditDialog(task)"
        >
          <mat-icon>edit</mat-icon>
        </button>
        <button
          mat-icon-button
          color="warn"
          *ngIf="isAdmin$ | async"
          (click)="deleteTask(task.id)"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>
</ng-template>
