<header class="page-header">
  <h1>Task List</h1>
  <div class="actions">
    <button
      mat-raised-button
      color="primary"
      *ngIf="isAdmin$ | async"
      (click)="openAddDialog()"
      aria-label="Add new task"
    >
      Add Task
    </button>
  </div>
</header>
<div class="filters">
  <mat-form-field appearance="outline">
    <mat-label>Search Tasks</mat-label>
    <input
      matInput
      placeholder="Search by title, description, etc."
      (input)="onSearch($event)"
      aria-label="Search tasks"
    />
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Status</mat-label>
    <mat-select
      [formControl]="statusControl"
      placeholder="All"
      aria-label="Filter by status"
    >
      <mat-option value="">All</mat-option>
      <mat-option value="To Do">To Do</mat-option>
      <mat-option value="In Progress">In Progress</mat-option>
      <mat-option value="In Review">In Review</mat-option>
      <mat-option value="Completed">Completed</mat-option>
    </mat-select>
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Priority</mat-label>
    <mat-select
      [formControl]="priorityControl"
      placeholder="All"
      aria-label="Filter by priority"
    >
      <mat-option value="">All</mat-option>
      <mat-option value="Low">Low</mat-option>
      <mat-option value="Medium">Medium</mat-option>
      <mat-option value="High">High</mat-option>
      <mat-option value="Critical">Critical</mat-option>
    </mat-select>
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Category</mat-label>
    <mat-select
      [formControl]="categoryControl"
      placeholder="All"
      aria-label="Filter by category"
    >
      <mat-option value="">All</mat-option>
      <mat-option *ngFor="let category of categories" [value]="category">{{
        category
      }}</mat-option>
    </mat-select>
  </mat-form-field>
</div>
<div
  *ngIf="loading$ | async; else taskTable"
  class="loading"
  aria-live="polite"
>
  <p>Loading tasks...</p>
</div>
<ng-template #taskTable>
  <div *ngIf="error$ | async as error" class="error-message" role="alert">
    <p>Error: {{ error }}</p>
  </div>
  <div class="table-container">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      (matSortChange)="sortData($event)"
      aria-label="Task list table"
    >
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Title</th>
        <td mat-cell *matCellDef="let task">{{ task.title }}</td>
      </ng-container>
      <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Description</th>
        <td mat-cell *matCellDef="let task" [innerHTML]="task.description"></td>
      </ng-container>
      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
        <td mat-cell *matCellDef="let task">
          <span
            class="priority-chip"
            [ngClass]="{
              'priority-low': task.priority === 'Low',
              'priority-medium': task.priority === 'Medium',
              'priority-high': task.priority === 'High',
              'priority-critical': task.priority === 'Critical'
            }"
          >
            {{ task.priority }}
          </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="dueDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
        <td
          mat-cell
          *matCellDef="let task"
          [ngClass]="{
            'due-date-overdue': isOverdue(task.dueDate)
          }"
        >
          {{ task.dueDate }}
        </td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let task">
          <span
            class="status-chip"
            [ngClass]="{
              'status-todo': task.status === 'To Do',
              'status-inprogress': task.status === 'In Progress',
              'status-inreview': task.status === 'In Review',
              'status-completed': task.status === 'Completed'
            }"
          >
            {{ task.status }}
          </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Category</th>
        <td mat-cell *matCellDef="let task">{{ task.category }}</td>
      </ng-container>
      <ng-container matColumnDef="tags">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Tags</th>
        <td mat-cell *matCellDef="let task">
          <mat-chip-listbox>
            <mat-chip *ngFor="let tag of task.tags">{{ tag }}</mat-chip>
          </mat-chip-listbox>
        </td>
      </ng-container>
      <ng-container matColumnDef="assignedTo">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Assigned To</th>
        <td mat-cell *matCellDef="let task">{{ task.assignedTo }}</td>
      </ng-container>
      <ng-container matColumnDef="attachments">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Attachments</th>
        <td mat-cell *matCellDef="let task">
          <span *ngIf="task.attachments.length === 0">None</span>
          <ul *ngIf="task.attachments.length > 0">
            <li *ngFor="let attachment of task.attachments">
              {{ attachment.name }} ({{ attachment.size | number }} bytes)
            </li>
          </ul>
        </td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let task" class="actions-cell">
          <button
            mat-icon-button
            *ngIf="isAdmin$ | async"
            (click)="openEditDialog(task)"
            matTooltip="Edit Task"
            aria-label="Edit task"
          >
            <mat-icon>edit</mat-icon>
          </button>
          <button
            mat-icon-button
            color="warn"
            *ngIf="isAdmin$ | async"
            (click)="deleteTask(task.id)"
            matTooltip="Delete Task"
            aria-label="Delete task"
          >
            <mat-icon>delete</mat-icon>
          </button>
          <button
            mat-icon-button
            color="accent"
            (click)="onComment(task)"
            matTooltip="Comment"
            aria-label="Add comment"
          >
            <mat-icon>comment</mat-icon>
          </button>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
</ng-template>
